(this.webpackJsonpchat_client=this.webpackJsonpchat_client||[]).push([[0],{15:function(e,s,t){},16:function(e,s,t){},18:function(e,s,t){"use strict";t.r(s);var n=t(1),a=t.n(n),i=t(8),r=t.n(i),o=(t(15),t(2)),c=t(3),l=t(5),u=t(4),h=(t(16),t(9)),d=t(6),m=t(10),g=new(function(){function e(){Object(o.a)(this,e),this.url="",this.user_list=[],this.stream=null,this.streamToken=null,this.message_list=[],this.messageToken=null,this.stream=null,console.log("contruct chat kit service")}return Object(c.a)(e,[{key:"date_format",value:function(e){var s=new Date(1e3*e);return s.toLocaleDateString("en-US")+" "+s.toLocaleTimeString("en-US")}},{key:"clear_up",value:function(){this.url="http://localhost:3001",this.user_list=[],this.stream=null,this.streamToken=null,this.message_list=[],this.messageToken=null,this.stream=null}},{key:"login",value:function(e,s,t){return this.url=e,new Promise((function(n,a){var i=new FormData;i.append("password",t),i.append("username",s);var r=new XMLHttpRequest;r.open("POST",e+"/login"),console.log("send login information"),r.send(i),r.onreadystatechange=function(){if(4===r.readyState)if(201===r.status){var e=JSON.parse(r.responseText);this.messageToken=e.message_token,this.streamToken=e.stream_token,n({loginStatus:!0,streamToken:this.streamToken,messageToken:this.messageToken,username:s})}else 403===r.status?a("Invalid username or password"):409===r.status?a(s+" is already logged in"):a(r.status+" failure to /login!")}}))}},{key:"update_users",value:function(e){this.user_list=[];var s,t=Object(m.a)(Array.from(e).sort());try{for(t.s();!(s=t.n()).done;){var n=s.value;this.user_list.push(n)}}catch(a){t.e(a)}finally{t.f()}}},{key:"handle_disconnect",value:function(e){if(this.message="Please connect to send messages.",e){var s=new Set;this.update_users(s)}}},{key:"new_message",value:function(e){this.message_list.push({type:"MSG",time:this.date_format(e.created),user:e.user,msg:e.message})}},{key:"new_user",value:function(e){var s=new Set(this.user_list);s.add(e.user),this.update_users(s),this.message_list.push({type:"Join",time:this.date_format(e.created),user:e.user})}},{key:"depart_message",value:function(e){var s=new Set(this.user_list);s.delete(e.user),this.update_users(s),this.message_list.push({type:"Part",time:this.date_format(e.created),user:e.user,msg:"Part"})}},{key:"server_status",value:function(e){this.message_list.push({type:"ServerStatus",time:this.date_format(e.created),msg:e.status})}},{key:"show_login",value:function(){this.url="",this.username="",this.password=""}},{key:"start_stream",value:function(e,s,t){var n=this;console.log("start event connection!"),this.streamToken=t;var a=new EventSource(this.url+"/stream/"+this.streamToken),i=this.update_users.bind(this),r=this.new_message.bind(this),o=this.depart_message.bind(this),c=this.server_status.bind(this),l=this.handle_disconnect.bind(this),u=this.new_user.bind(this);a.addEventListener("error",(function(t){console.log("error"),2===t.target.readyState?(n.messageToken=null,n.streamToken=null,l(!0),n.clear_up.bind(n),s()):(l(!1),console.log("Disconnected, retrying")),e({user_list:n.user_list,message_list:n.message_list,kicked:!0})}),!1),a.addEventListener("Users",(function(s){console.log("users");var t=new Set(JSON.parse(s.data).users);i(t),e({user_list:n.user_list,message_list:n.message_list,kicked:!1})}),!1),a.addEventListener("open",(function(){console.log("open")})),a.addEventListener("Disconnect",(function(){console.log("Disconnect"),a.close(),l(!0),n.clear_up.bind(n),s(),e({user_list:n.user_list,message_list:n.message_list,kicked:!0})}),!1),a.addEventListener("Join",(function(s){console.log("Join");var t=JSON.parse(s.data);u(t),e({user_list:n.user_list,message_list:n.message_list,kicked:!1})}),!1),a.addEventListener("Message",(function(s){console.log("message");var t=JSON.parse(s.data);r(t),e({user_list:n.user_list,message_list:n.message_list,kicked:!1})}),!1),a.addEventListener("Part",(function(s){console.log("part");var t=JSON.parse(s.data);o(t),e({user_list:n.user_list,message_list:n.message_list,kicked:!1})}),!1),a.addEventListener("ServerStatus",(function(s){console.log("serverStatus");var t=JSON.parse(s.data);c(t),e({user_list:n.user_list,message_list:n.message_list,kicked:!1})}),!1)}},{key:"send_msg",value:function(e,s){var t=this;return this.messageToken=s,console.log("send_msg"),new Promise((function(s,n){var a=new FormData;a.append("message",e);var i=new XMLHttpRequest;i.open("POST",t.url+"/message"),i.setRequestHeader("Authorization","Bearer "+t.messageToken),i.send(a),i.onreadystatechange=function(e){4===e.target.readyState&&(4===e.target.readyState&&403!==e.target.status&&null!==this.messageToken?(this.messageToken=e.target.getResponseHeader("token"),s({status:!0,newMessageToken:this.messageToken})):n("Message is not sent sucessfully!"))}}))}}]),e}()),j=t(0),p=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(e){var n;return Object(o.a)(this,t),(n=s.call(this,e)).handleChange=function(e){return function(s){n.setState(Object(h.a)({},e,s.target.value))}},n.state={url:"https://chat.cs291.com",username:"",password:""},n.handleChange=n.handleChange.bind(Object(d.a)(n)),n.handleSubmit=n.handleSubmit.bind(Object(d.a)(n)),n}return Object(c.a)(t,[{key:"handleSubmit",value:function(e){var s=this;console.log(this.state.username+" is login to chat server."),e.preventDefault(),g.login(this.state.url,this.state.username,this.state.password).then((function(e){s.props.tryLogin(e)}),(function(e){alert(e)}))}},{key:"render",value:function(){return Object(j.jsxs)("form",{className:"login-modal",onSubmit:this.handleSubmit,children:[Object(j.jsx)("h2",{children:"Login"}),Object(j.jsxs)("div",{className:"login-page",children:[Object(j.jsx)("div",{children:Object(j.jsxs)("label",{children:["Chat URL ",Object(j.jsx)("br",{}),Object(j.jsx)("input",{type:"text",value:this.state.url,onChange:this.handleChange("url")})]})}),Object(j.jsx)("div",{children:Object(j.jsxs)("label",{children:["Username ",Object(j.jsx)("br",{}),Object(j.jsx)("input",{type:"text",value:this.state.username,onChange:this.handleChange("username")})]})}),Object(j.jsx)("div",{children:Object(j.jsxs)("label",{children:["Password ",Object(j.jsx)("br",{}),Object(j.jsx)("input",{type:"password",value:this.state.password,onChange:this.handleChange("password")})]})}),Object(j.jsxs)("div",{children:[Object(j.jsx)("br",{}),Object(j.jsx)("label",{children:Object(j.jsx)("input",{type:"submit",value:"Login"})})]})]})]})}}]),t}(n.Component),b=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(){var e;Object(o.a)(this,t);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=s.call.apply(s,[this].concat(a))).scrollToBottom=function(){setTimeout((function(){e.messagesEnd&&e.messagesEnd.scrollIntoView({behavior:"auto"})}),0)},e.ParseMsg=function(s){s&&e.scrollToBottom();var t=s.item;switch(t.type){case"ServerStatus":return Object(j.jsx)("li",{className:"status-item",children:Object(j.jsxs)("p",{children:[t.time," [STATUS]:  ",t.msg]})});case"Join":return Object(j.jsx)("li",{className:"status-item",children:Object(j.jsxs)("p",{children:[t.time," [JOIN]:  ",t.user]})});case"Part":return Object(j.jsx)("li",{className:"status-item",children:Object(j.jsxs)("p",{children:[t.time," [PART]:  ",t.user]})});case"MSG":return t.user===e.props.thisUser?Object(j.jsx)("li",{className:"my-msg",children:Object(j.jsxs)("p",{children:[t.time," ",t.user,": ",t.msg," "]})}):Object(j.jsx)("li",{className:"msg",children:Object(j.jsxs)("p",{children:[t.time," ",t.user,": ",t.msg," "]})});default:return Object(j.jsx)("li",{})}},e}return Object(c.a)(t,[{key:"render",value:function(){var e=this,s="black";return this.props.kicked&&(s="grey"),Object(j.jsx)("div",{className:"chat",color:s,"text-shadow":"",children:Object(j.jsxs)("ul",{className:"message_list",children:[this.props.MsgsProp.map((function(s,t){return Object(j.jsx)(e.ParseMsg,{item:s},t)})),Object(j.jsx)("div",{style:{float:"left",clear:"both"},ref:function(s){e.messagesEnd=s}})]})})}}]),t}(n.Component),k=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(){return Object(o.a)(this,t),s.apply(this,arguments)}return Object(c.a)(t,[{key:"render",value:function(){var e="black";return this.props.kicked&&(e="grey"),Object(j.jsxs)("div",{className:"user_window",color:e,children:[Object(j.jsx)("h2",{children:"Online"}),Object(j.jsx)("ul",{className:"users",color:e,children:this.props.user_list.map((function(e,s){return Object(j.jsx)("li",{children:e},s)}))})]})}}]),t}(n.Component),v=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(e){var n;return Object(o.a)(this,t),(n=s.call(this,e)).prepareMessage=function(e){n.setState({message:e.target.value})},n.onSend=function(e){var s;e.preventDefault(),s=n.state.messageToken?n.state.messageToken:n.props.messageTokenProp,g.send_msg(n.state.message,s).then((function(e){n.setState({message:"",messageToken:e.newMessageToken})}),(function(e){alert(e)}))},n.state={message:"",messageToken:null},n}return Object(c.a)(t,[{key:"componentDidMount",value:function(){this.onSend=this.onSend.bind(this)}},{key:"render",value:function(){var e="",s=!1;return this.props.kicked&&(s=!0,e="You're kicked off, please re-connect to server."),Object(j.jsx)("form",{onSubmit:this.onSend,children:Object(j.jsx)("input",{className:"message",type:"text",onChange:this.prepareMessage,value:this.state.message,disabled:s,placeholder:e})})}}]),t}(n.Component),f=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(e){var n;return Object(o.a)(this,t),(n=s.call(this,e)).onChatUpdate=function(e){console.log("callback:"),n.setState({user_list:e.user_list,message_list:e.message_list,kicked:e.kicked})},n.handleDisconnect=function(){n.props.handleDisconnect()},n.state={user_list:[],message_list:[],kicked:!1,message:"",messageToken:null},n}return Object(c.a)(t,[{key:"componentDidMount",value:function(){this.onChatUpdate=this.onChatUpdate.bind(this),g.start_stream(this.onChatUpdate,this.handleDisconnect,this.props.streamToken)}},{key:"render",value:function(){var e="green";return this.state.kicked&&(e="red"),Object(j.jsxs)("div",{className:"container",children:[Object(j.jsx)("h1",{className:"connected",style:{color:e},children:"CS291 Chat"}),Object(j.jsxs)("div",{className:"window",children:[Object(j.jsx)(b,{MsgsProp:this.state.message_list,thisUser:this.props.username,kicked:this.state.kicked}),Object(j.jsx)(k,{user_list:this.state.user_list,kicked:this.state.kicked})]}),Object(j.jsx)(v,{messageTokenProp:this.props.messageTokenProp,kicked:this.state.kicked})]})}}]),t}(n.Component),O=function(e){Object(l.a)(t,e);var s=Object(u.a)(t);function t(e){var n;return Object(o.a)(this,t),(n=s.call(this,e)).onLogin=function(e){e.loginStatus&&n.setState({isLoggedIn:!0,streamToken:e.streamToken,messageToken:e.messageToken,username:e.username})},n.handleDisconect=function(){n.setState({isLoggedIn:!1,streamToken:""})},n.state={isLoggedIn:!1,streamToken:null,messageToken:null,username:""},n}return Object(c.a)(t,[{key:"render",value:function(){var e;return e=this.state.isLoggedIn?Object(j.jsx)(f,{handleDisconnect:this.handleDisconect,streamToken:this.state.streamToken,messageTokenProp:this.state.messageToken,username:this.state.username}):Object(j.jsx)(p,{tryLogin:this.onLogin}),Object(j.jsx)("div",{className:"App",children:e})}}]),t}(n.Component),_=function(e){e&&e instanceof Function&&t.e(3).then(t.bind(null,19)).then((function(s){var t=s.getCLS,n=s.getFID,a=s.getFCP,i=s.getLCP,r=s.getTTFB;t(e),n(e),a(e),i(e),r(e)}))};r.a.render(Object(j.jsx)(a.a.StrictMode,{children:Object(j.jsx)(O,{})}),document.getElementById("root")),_()}},[[18,1,2]]]);
//# sourceMappingURL=main.426166fa.chunk.js.map